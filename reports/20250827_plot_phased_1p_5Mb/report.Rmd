---
title: "`r params$title`"
author: "Alexandra Tidd"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    fig_width: 8
    keep_md: true
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 4
    theme: lumen
params:
  title: null
  cache_path: null
  rerun: false
---

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = "../..")
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  dpi = 300,
  cache.path = params$cache_path,
  fig.align = "center"
)
```

```{r setup2, include = FALSE}
# libraries
library(magrittr)
library(dplyr)
library(ggplot2)

# set ggplot presets
theme_set(theme_classic())

# function: plot phased baf
plot_baf <- function(p_dat, min_depth = 5) {
  # prep data
  p_dat2 <-
    p_dat %>%
    filter(total_depth >= min_depth) %>%
    dplyr::mutate(mut_baf = 1 - mut_vaf,
                  chr = factor(sub("^chr", "", chr),
                               levels = c(as.character(1:22), "X", "Y")),
                  `pos (Mb)` = pos / 1e6) %>%
    tidyr::pivot_longer(cols = c("mut_vaf", "mut_baf"), names_to = "vaf_type")

  # prep phased data
  p_dat_phased <-
    p_dat2 %>%
    filter(!is.na(hap_A_vaf) & vaf_type == "mut_vaf")

  # plot
  p_dat2 %>%
    ggplot(aes(x = `pos (Mb)`, y = value)) +
    # add line at vaf = 0.5
    geom_hline(yintercept = 0.5, colour = "red") +
    # add baf points
    geom_point(size = 0.8, alpha = 0.2) +
    # add phased points
    geom_point(data = p_dat_phased, aes(y = hap_A_vaf), colour = "#e03ba9",
               size = 1) +
    geom_point(data = p_dat_phased, aes(y = hap_B_vaf), colour = "#00ccff",
               size = 1) +
    # add line at TNFRSF14
    geom_vline(xintercept = 2487078 / 1e6, colour = "green") +
    # increase x axis breaks
    scale_x_continuous(#expand = c(0, 0),
                       breaks = pretty(p_dat2$`pos (Mb)`, n = 20)) +
    ggh4x::facet_grid2(. ~ chr, scales = "free_x", space = "free_x") +
    theme_classic() +
    theme(panel.grid.major = element_line(),
          panel.grid.minor.x = element_line(),
          strip.background = element_rect(color = "grey", fill = NA,
                                          linewidth = 0, linetype = "solid")) +
    # rotate x axis text using guides
    guides(x = guide_axis(angle = -90))
}
```

# Parameters

```{r params, echo = FALSE}
params %>%
  tibble::enframe() %>%
  knitr::kable()
```

# Load SNPs

```{r load_snps, eval = F}
snps <-
  c("dna", "dnahyb") %>%
  purrr::set_names() %>%
  purrr::map(function(type) {
    file.path("out/resolveome/nf-resolveome", type,
              "PD63118/genotyping/snps/PD63118_genotyped_snps.tsv") %>%
      readr::read_tsv() %>%
      dplyr::filter(chr == "1", pos < 5e6) %>%
      dplyr::mutate(cell_id = sub("_dna.*", "", id)) %>%
      split(.$cell_id)
  })

saveRDS(snps, "reports/20250827_plot_phased_1p_5Mb/snps.rds")
```

```{r load_snps2}
snps <- readRDS("reports/20250827_plot_phased_1p_5Mb/snps.rds")
```

# Phase SNPs

```{r phase_snps}
# load phasing from plate3_wellA2
plate3_wellA2 <-
  readRDS("out/phase_snps/phase_snps_cache/plate3_wellA2_phased_snps.rds")

# phase snps
cell_ids <- unique(unlist(lapply(snps, names)))
phased_snps <- list()
purrr::walk(cell_ids, function(cell_id_i) {
  phased_snps[[cell_id_i]] <<- list()
  purrr::walk(list("dna", "dnahyb"), function(type_i) {
    if (!is.null(snps[[type_i]][[cell_id_i]])) {
      phased_snps[[cell_id_i]][[type_i]] <<-
        snps[[type_i]][[cell_id_i]] %>%
        left_join(
          plate3_wellA2 %>%
            distinct(chr, pos, ref, alt, hap_A_type, hap_B_type) %>%
            filter(!is.na(hap_A_type))) %>%
        mutate(hap_A_vaf = case_when(hap_A_type == "alt" ~ mut_vaf,
                                      hap_A_type == "ref" ~ 1 - mut_vaf),
                hap_B_vaf = case_when(hap_B_type == "alt" ~ mut_vaf,
                                      hap_B_type == "ref" ~ 1 - mut_vaf))
    }
  })
})
```

# Plot BAFs

```{r plot_bafs, fig.width = 10}
purrr::walk2(names(phased_snps) %>% head(2), phased_snps %>% head(2), function(cell_id_i, x) {

  print(cell_id_i)

  purrr::walk2(names(x), x, function(type_i, i) {

    print(type_i)

    min_depth <- ifelse(type_i == "dna", 5, 10)

    # first 5Mb
    p <-
      plot_baf(i, min_depth = min_depth) +
      ggtitle(paste0(cell_id_i,  " - ", type_i, " (first 5Mb, min depth = ",
                     min_depth, ")"))
    print(p)

    # 200kb around TNFRSF14
    p <-
      i %>%
      filter(pos > 2487078 - 2e5, pos < 2487078 + 2e5) %>%
      plot_baf(min_depth = min_depth) +
      ggtitle(paste0(cell_id_i, " - ", type_i,
                     " (200kb around TNFRSF14, min depth = ", min_depth, ")"))
    print(p)

  })
})
```