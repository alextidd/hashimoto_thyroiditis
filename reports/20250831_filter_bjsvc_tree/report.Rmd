---
title: "`r params$title`"
author: "Alexandra Tidd"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    fig_width: 8
    keep_md: true
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 4
    theme: lumen
params:
  title: null
  cache_path: null
  rerun: false
---

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = "../..")
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  dpi = 300,
  cache.path = params$cache_path,
  fig.align = "center"
)
```

```{r setup2, include = FALSE}
# libraries
library(magrittr)
library(dplyr)
library(ggplot2)
library(readr)
library(tidyr)
library(liftOver)
library(ape)
library(patchwork)

# set ggplot presets
theme_set(theme_classic())

# dirs
seq_dir <- "out/resolveome/sequoia/20250917/"
```

# Parameters

```{r params, echo = FALSE}
params
```

# Samplesheet

```{r load_ss}
# load manual inspection data
man_insp <-
  read_tsv("data/resolveome/manual_inspection/PD63118.tsv") %>%
  dplyr::select(-run_id) %>%
  # fix loh_1p
  mutate(loh_1p = as.character(as.numeric(loh_1p)),
         loh_9p = as.character(as.numeric(loh_9p)),
         loh_9q = as.character(as.numeric(loh_9q)))

# load samplesheet
ss <-
  file.path(Sys.getenv("LUSTRE_125"),
            "projects/hashimoto_thyroiditis/data/bams/samplesheet_local.csv") %>%
  read_csv() %>%
  # add manual inspection data
  inner_join(man_insp)

# qc-passing cells
ss_pass <-
  ss %>%
  filter((plate == 3 & !suspected_doublet & !chr_dropout) |
         (plate == 10 &
          (is.na(suspected_doublet) | !suspected_doublet) &
          (is.na(chr_dropout) | !chr_dropout)))

# get celltype annotations
cts <-
  ss_pass %>%
  # synthesise celltype annotations from VDJ + SHM + CSR
  mutate(
    celltype_VDJ_SHM_CSR = case_when(
      celltype_VDJ_recomb == "B cell" &
        (celltype_SHM == "mature B cell" |
         class_switch_recombination_CSR == TRUE) ~ "activated B",
      celltype_VDJ_recomb == "B cell" & celltype_SHM == "not mature B cell" ~ "naive B",
      celltype_VDJ_recomb == "alpha-beta T cell" ~ "T",
      celltype_VDJ_recomb == "not lymphocyte" ~ "other",
      TRUE ~ NA) %>%
      factor(levels = c("activated B", "naive B", "T", "other"))) %>%
  filter(!is.na(celltype_VDJ_SHM_CSR)) %>%
  distinct(cell_id, celltype_VDJ_SHM_CSR)

# subset samplesheet
ss_annot <-
  ss_pass %>%
  inner_join(cts)
```

We plot the tree.

```{r tree, fig.width = 10, fig.height = 10}
# load tree
tree <-
  file.path(seq_dir, "Patient_both_tree_with_branch_length.tree") %>%
  ape::read.tree()

# load cell id to new cell id
cell_annots <-
  tibble::tibble(id = tree$tip.label) %>%
  left_join(
    file.path(Sys.getenv("LUSTRE_125"),
              "projects/hashimoto_thyroiditis/out/resolveome/basejumper",
              "bj-somatic-variantcalling/dna/PD63118/samplesheet.csv") %>%
      readr::read_csv() %>%
      transmute(id = biosampleName, cell_id = gsub("_dna.*", "", id)) %>%
      # add new cells ids + additional annotations
      left_join(
        readr::read_tsv("data/resolveome/manual_inspection/pta_additional_annotation_H1.tsv") %>%
          mutate(cell_id_new = cell_ID, cell_id = well_ID)
      )
  )

# prune tips not in the new cell ids
to_prune <- cell_annots %>% filter(is.na(cell_id_new)) %>% pull(id)
pruned_tree <- drop.tip(tree, to_prune)
cell_annots_pruned <-
  cell_annots %>%
  filter(!is.na(cell_id_new))

# rename tips
pruned_tree$tip.label <- cell_annots_pruned$cell_id_new

# plain tree
plot(pruned_tree, cex = 0.7)
axisPhylo(side = 1, backward = FALSE)

# tree coloured by celltype
tip_cols <- ifelse(cell_annots_pruned$celltype_VDJ_recomb == "B cell", "blue",
            ifelse(cell_annots_pruned$celltype_VDJ_recomb == "alpha-beta T cell", "red", "grey"))
plot(pruned_tree, tip.color = tip_cols, cex = 0.7)
axisPhylo(side = 1, backward = FALSE)
legend("topright",
       legend = c("B cell", "alpha-beta T cell", "not lymphocyte"),
       col    = c("blue", "red", "grey"),
       pch    = 19,
       pt.cex = 1,
       bty    = "n")

# tree coloured by biallelic_CD274
tip_cols <- ifelse(cell_annots_pruned$biallelic_CD274 == "TRUE_Compound", "blue",
            ifelse(cell_annots_pruned$biallelic_CD274 == "TRUE_LOH", "#3ec83e",
            ifelse(cell_annots_pruned$biallelic_CD274 == "FALSE_Het", "red",
            ifelse(cell_annots_pruned$biallelic_CD274 == "Unclear - 9p del + intronic", "purple",
                   "grey"))))
plot(pruned_tree, tip.color = tip_cols, cex = 0.7)
axisPhylo(side = 1, backward = FALSE)
legend("topright",
       legend = c("TRUE_Compound", "TRUE_LOH", "FALSE_Het", "Unclear - 9p del + intronic", "WT/-"),
       col    = c("blue", "#3ec83e", "red", "purple", "grey"),
       pch    = 19,
       pt.cex = 1,
       bty    = "n")

# tree coloured by SHM
tip_cols <- ifelse(cell_annots_pruned$celltype_SHM == "Mature B cell", "blue",
                   "red")
plot(pruned_tree, tip.color = tip_cols, cex = 0.7)
axisPhylo(side = 1, backward = FALSE)
legend("topright",
       legend = c("Mature B cell", "Not mature B cell"),
       col    = c("blue", "red"),
       pch    = 19,
       pt.cex = 1,
       bty    = "n")
```