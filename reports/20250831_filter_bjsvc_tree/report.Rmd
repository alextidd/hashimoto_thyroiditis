---
title: "`r params$title`"
author: "Alexandra Tidd"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    fig_width: 8
    keep_md: true
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 4
    theme: lumen
params:
  title: null
  cache_path: null
  rerun: false
---

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = "../..")
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  dpi = 300,
  cache.path = params$cache_path,
  fig.align = "center"
)
```

```{r setup2, include = FALSE}
# libraries
library(magrittr)
library(dplyr)
library(ggplot2)
library(readr)
library(tidyr)
library(liftOver)

# set ggplot presets
theme_set(theme_classic())
```

# Parameters

```{r params, echo = FALSE}
params %>%
  tibble::enframe() %>%
  knitr::kable()
```

# Samplesheet

```{r load_ss}
# load manual inspection data
man_insp <-
  read_tsv("data/resolveome/manual_inspection/PD63118.tsv") %>%
  dplyr::select(-run_id) %>%
  # fix loh_1p
  mutate(loh_1p = as.character(as.numeric(loh_1p)),
         loh_9p = as.character(as.numeric(loh_9p)),
         loh_9q = as.character(as.numeric(loh_9q)))

# load samplesheet
ss <-
  file.path(Sys.getenv("LUSTRE_125"),
            "projects/hashimoto_thyroiditis/data/bams/samplesheet_local.csv") %>%
  read_csv() %>%
  # add manual inspection data
  inner_join(man_insp)

# qc-passing cells
ss_pass <-
  ss %>%
  filter((plate == 3 & !suspected_doublet & !chr_dropout) |
         (plate == 10 &
          (is.na(suspected_doublet) | !suspected_doublet) &
          (is.na(chr_dropout) | !chr_dropout)))

# get celltype annotations
cts <-
  ss_pass %>%
  # synthesise celltype annotations from VDJ + SHM + CSR
  mutate(
    celltype_VDJ_SHM_CSR = case_when(
      celltype_VDJ_recomb == "B cell" &
        (celltype_SHM == "mature B cell" |
         class_switch_recombination_CSR == TRUE) ~ "activated B",
      celltype_VDJ_recomb == "B cell" & celltype_SHM == "not mature B cell" ~ "naive B",
      celltype_VDJ_recomb == "alpha-beta T cell" ~ "T",
      celltype_VDJ_recomb == "not lymphocyte" ~ "other",
      TRUE ~ NA) %>%
      factor(levels = c("activated B", "naive B", "T", "other"))) %>%
  filter(!is.na(celltype_VDJ_SHM_CSR)) %>%
  distinct(cell_id, celltype_VDJ_SHM_CSR)

# subset samplesheet
ss_annot <-
  ss_pass %>%
  inner_join(cts)
```

# Somatic mutation calling

We load mutation calls from `bj-somatic-variantcalling` and we combine the calls
per cell.

```{r load_bjsvc}
# get NR and NV
bj_muts_per_seq_type_38 <-
  c("dna") %>% # "dnahyb"
  purrr::set_names() %>%
  purrr::map(function(seq_type) {
    # get nr and nv
    c("mut_depth" = "NV", "total_depth" = "NR") %>%
      purrr::map(function(i) {
        file.path("out/resolveome/basejumper/bj-somatic-variantcalling",
                  seq_type, "PD63118/PD63118_run",
                  "SOMATIC_VARIANT_WORKFLOW_Heuristic_Filter_SEQUOIA",
                  paste0("Sequoia_group_null_bino-10_rhosnp0.4_rhoindel0.4_mincov10_maxcov500_both_",
                         i, "_filtered_all.txt")) %>%
          read.table() %>%
          tibble::rownames_to_column(var = "mut_id")
      }) %>%
      bind_rows(.id = "name") %>%
      pivot_longer(cols = -c("name", "mut_id"), names_to = "id") %>%
      pivot_wider() %>%
      separate_wider_delim(cols = "mut_id", delim = "_", cols_remove = FALSE,
                           names = c("chr", "pos", "ref", "alt")) %>%
      mutate(pos = as.numeric(pos)) %>%
      # calculate global VAFs
      group_by(mut_id) %>%
      mutate(mut_vaf = mut_depth / total_depth,
             global_mut_depth = sum(mut_depth),
             global_total_depth = sum(total_depth),
             global_mut_vaf = global_mut_depth / global_total_depth) %>%
      ungroup() %>%
      # get muts only
      filter(mut_depth > 0)
  }) %>%
  bind_rows(.id = "seq_type") %>%
  # filter to only annotated, qc'ed cells
  inner_join(ss_annot %>% distinct(id, cell_id, celltype_VDJ_SHM_CSR, loh_1p))

# lift over to grch37
bj_muts_per_seq_type <-
  bj_muts_per_seq_type_38 %>%
  dplyr::mutate(pos_38 = pos) %>%
  alexr::lift_over("../../reference/liftover/hg38ToHg19.over.chain")

# view
bj_muts_per_seq_type
```

We visualise the global VAF distribution.

```{r plot_global_vaf}
bj_muts_per_seq_type %>%
  distinct(chr, mut_id, seq_type, global_mut_vaf) %>%
  ggplot(aes(x = global_mut_vaf)) +
  geom_histogram(bins = 100) +
  lims(x = c(NA, 1)) +
  ggh4x::facet_nested(seq_type ~ ., scales = "free_y") +
  scale_y_continuous(trans = scales::pseudo_log_trans()) +
  theme_bw() +
  geom_vline(xintercept = 0.25, linetype = "dashed", color = "red")+
  geom_vline(xintercept = median(bj_muts_per_seq_type$global_mut_vaf))
```

We filter out mutations with...
- global mutant VAF > 0.25
- mutant VAF < 0.3
- mutant depth <= 5

```{r global_vaf_filter}
bj_muts_per_seq_type_filter <-
  bj_muts_per_seq_type %>%
  filter(global_mut_vaf < 0.25,
         mut_vaf > 0.3, mut_depth > 5) %>%
  group_by(chr, pos, ref, alt) %>%
  mutate(n_cells_w_mut = n_distinct(cell_id),
         n_cells = n_distinct(bj_muts_per_seq_type$cell_id)) %>%
  filter(n_cells_w_mut / n_cells < 0.5) %>%
  ungroup()
```

We visualise the global VAF distribution after filtering.

```{r plot_global_vaf_filter}
bj_muts_per_seq_type_filter %>%
  distinct(chr, mut_id, seq_type, global_mut_vaf) %>%
  ggplot(aes(x = global_mut_vaf)) +
  geom_histogram(bins = 100) +
  lims(x = c(NA, 1)) +
  ggh4x::facet_nested(seq_type ~ ., scales = "free_y") +
  scale_y_continuous(trans = scales::pseudo_log_trans()) +
  theme_bw() +
  geom_vline(xintercept = median(bj_muts_per_seq_type_filter$global_mut_vaf))
```

We save the filtered calls.

```{r save_filtered_calls}
write_tsv(bj_muts_per_seq_type_filter,
          file.path(params$cache_path, "filtered_mutations.tsv"))
```