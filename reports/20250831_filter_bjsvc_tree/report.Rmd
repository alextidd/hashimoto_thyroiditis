---
title: "`r params$title`"
author: "Alexandra Tidd"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    fig_width: 8
    keep_md: true
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 4
    theme: lumen
params:
  title: null
  cache_path: null
  rerun: false
---

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = "../..")
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  dpi = 300,
  cache.path = params$cache_path,
  fig.align = "center"
)
```

```{r setup2, include = FALSE}
# libraries
library(magrittr)
library(dplyr)
library(ggplot2)
library(readr)
library(tidyr)
library(liftOver)
library(ape)
library(patchwork)

# set ggplot presets
theme_set(theme_classic())

# dirs
seq_dir <- "out/resolveome/sequoia/20250918/"
```

# Parameters

```{r params, echo = FALSE}
params
```

# Samplesheet

```{r load_ss}
# load manual inspection data
man_insp <-
  read_tsv("data/resolveome/manual_inspection/PD63118.tsv") %>%
  dplyr::select(-run_id) %>%
  # fix loh_1p
  mutate(loh_1p = as.character(as.numeric(loh_1p)),
         loh_9p = as.character(as.numeric(loh_9p)),
         loh_9q = as.character(as.numeric(loh_9q)))

# load samplesheet
ss <-
  file.path(Sys.getenv("LUSTRE_125"),
            "projects/hashimoto_thyroiditis/data/bams",
            "samplesheet_local.csv") %>%
  read_csv() %>%
  # add manual inspection data
  inner_join(man_insp)

# qc-passing cells
ss_pass <-
  ss %>%
  filter((plate == 3 & !suspected_doublet & !chr_dropout) |
         (plate == 10 &
          (is.na(suspected_doublet) | !suspected_doublet) &
          (is.na(chr_dropout) | !chr_dropout)))

# get celltype annotations
cts <-
  ss_pass %>%
  # synthesise celltype annotations from VDJ + SHM + CSR
  mutate(
    celltype_VDJ_SHM_CSR = case_when(
      celltype_VDJ_recomb == "B cell" &
        (celltype_SHM == "mature B cell" |
         class_switch_recombination_CSR == TRUE) ~ "activated B",
      celltype_VDJ_recomb == "B cell" & celltype_SHM == "not mature B cell" ~ "naive B",
      celltype_VDJ_recomb == "alpha-beta T cell" ~ "T",
      celltype_VDJ_recomb == "not lymphocyte" ~ "other",
      TRUE ~ NA) %>%
      factor(levels = c("activated B", "naive B", "T", "other"))) %>%
  filter(!is.na(celltype_VDJ_SHM_CSR)) %>%
  distinct(cell_id, celltype_VDJ_SHM_CSR)

# subset samplesheet
ss_annot <-
  ss_pass %>%
  inner_join(cts)
```

We plot the tree.

```{r tree, fig.width = 10, fig.height = 10}
# load tree
tree <-
  file.path(seq_dir, "Patient_both_tree_with_branch_length.tree") %>%
  ape::read.tree()

# load cell id to new cell id
cell_annots <-
  tibble::tibble(id = tree$tip.label) %>%
  left_join(
    file.path(Sys.getenv("LUSTRE_125"),
              "projects/hashimoto_thyroiditis/out/resolveome/basejumper",
              "bj-somatic-variantcalling/dna/PD63118/samplesheet.csv") %>%
      readr::read_csv() %>%
      transmute(id = biosampleName, cell_id = gsub("_dna.*", "", id)) %>%
      # add new cells ids + additional annotations
      left_join(
        "data/resolveome/manual_inspection/pta_additional_annotation_H1.tsv" %>%
          readr::read_tsv() %>%
          mutate(cell_id_new = cell_ID, cell_id = well_ID)
      )
  )

# tree with ids
plot(tree, cex = 0.7)
axisPhylo(side = 1, backward = FALSE)

# tree with ids, equal branch lengths
tree_collapsed <- tree
tree_collapsed$edge.length <- rep(1, nrow(tree_collapsed$edge))
plot(tree_collapsed)
```

We look at the mutational signatures of various clades of interest.

```{r sigs, fig.width = 10, fig.height = 10}
# load mutations assigned to cells
mats <-
  c("NV", "NR") %>%
  purrr::set_names() %>%
  purrr::map(function(i) {
    file.path(seq_dir, paste0("Patient_both_", i, "_tree_all.txt")) %>%
      read.table
  })

# load mutations assigned to tree
muts_to_branches <-
  file.path(seq_dir, "Patient_both_assigned_to_branches.txt") %>%
  readr::read_tsv() %>%
  janitor::clean_names()

# get 96 contexts
contexts <-
  muts_to_branches %>%
  muts_to_96_contexts(
    fasta = "../../reference/gatk/GRCh38/Homo_sapiens_assembly38.fasta.gz")

# get nodepaths
tip_of_interest <- which(tree$tip.label == "plate10_wellE4_dna_run50382")
path_nodes <- nodepath(tree, from = Ntip(tree) + 1, to = tip_of_interest)

# function: get the mutational spectrum of the mrca edge of a list of tips
get_edge_spectrum <- function(tree, muts_to_branches, edge_tips) {

  if (length(edge_tips) > 1) {
    # get mrca of clade
    edge_mrca <- getMRCA(tree, edge_tips)
    edge_of_interest <- which(tree$edge[, 2] == edge_mrca)
  } else {
    # get parent node of tip
    edge_mrca <- which(tree$edge[, 2] == which(tree$tip.label == edge_tips))
    edge_of_interest <- edge_mrca
  }

  # find the edge that ends at this node
  edge_labels <- rep(NA, nrow(tree$edge))
  edge_labels[edge_of_interest] <- "edge of interest"
  tip_colours <- ifelse(tree$tip.label %in% edge_tips, "red", "black")
  plot(tree, cex = 0.7, main = paste(edge_tips, collapse = ", "),
       tip.color = tip_colours)
  edgelabels(text = edge_labels, cex = 0.7, frame = "none", col = "red")
  axisPhylo(side = 1, backward = FALSE)

  # get mutations on that branch
  edge_muts <-
    muts_to_branches %>%
    dplyr::filter(branch == edge_mrca) %>%
    alexr::get_trinucs(
      fasta = "../../reference/gatk/GRCh38/Homo_sapiens_assembly38.fasta.gz")

  # plot trinucs
  edge_muts %>% alexr::plot_trinucs()

}

# plot clade of 4
get_edge_spectrum(
  tree, muts_to_branches,
  edge_tips = c("plate10_wellH5_dna_run50382", "plate3_wellE11_dna_run49882",
                "plate10_wellA8_dna_run50382", "plate3_wellD4_dna_run49882"))

# plot CD274 clade
get_edge_spectrum(
  tree, muts_to_branches,
  edge_tips = c("plate10_wellF7_dna_run50382", "plate10_wellF6_dna_run50382"))

# plot CD274 clade + outgroup
get_edge_spectrum(
  tree, muts_to_branches,
  edge_tips = c("plate10_wellF7_dna_run50382", "plate10_wellF6_dna_run50382",
                "plate10_wellC9_dna_run50382"))

# # plot each CD274 tip
# get_edge_spectrum(
#   tree, muts_to_branches, edge_tips = "plate10_wellF7_dna_run50382")
# get_edge_spectrum(
#   tree, muts_to_branches, edge_tips = "plate10_wellF6_dna_run50382")
```

```{r plot_trinucs}
# plot trinuc
trinucs <-
  ingroup_muts %>%
  alexr::get_trinucs(
    fasta = "../../reference/gatk/GRCh38/Homo_sapiens_assembly38.fasta.gz")

trinucs %>%
  alexr::plot_trinucs()
```

Now we plot the tree with various annotations.

```{r plot_trees, fig.width = 10, fig.height = 10}
# rename tips
tree$tip.label <- cell_annots$cell_id_new

# plain tree
plot(tree, cex = 0.7)
axisPhylo(side = 1, backward = FALSE)

# tree coloured by celltype
tip_cols <- ifelse(cell_annots$celltype_VDJ_recomb == "B cell", "blue",
            ifelse(cell_annots$celltype_VDJ_recomb == "alpha-beta T cell", "red", "grey"))
plot(tree, tip.color = tip_cols, cex = 0.7)
axisPhylo(side = 1, backward = FALSE)
legend("topright",
       legend = c("B cell", "alpha-beta T cell", "not lymphocyte"),
       col    = c("blue", "red", "grey"),
       pch    = 19,
       pt.cex = 1,
       bty    = "n")

# tree coloured by biallelic_CD274
tip_cols <- ifelse(cell_annots$biallelic_CD274 == "TRUE_Compound", "blue",
            ifelse(cell_annots$biallelic_CD274 == "TRUE_LOH", "#3ec83e",
            ifelse(cell_annots$biallelic_CD274 == "FALSE_Het", "red",
            ifelse(cell_annots$biallelic_CD274 == "Unclear - 9p del + intronic", "purple",
                   "grey"))))
plot(tree, tip.color = tip_cols, cex = 0.7)
axisPhylo(side = 1, backward = FALSE)
legend("topright",
       legend = c("TRUE_Compound", "TRUE_LOH", "FALSE_Het", "Unclear - 9p del + intronic", "WT/-"),
       col    = c("blue", "#3ec83e", "red", "purple", "grey"),
       pch    = 19,
       pt.cex = 1,
       bty    = "n")

# tree coloured by SHM
tip_cols <- ifelse(cell_annots$celltype_SHM == "Mature B cell", "blue",
                   "red")
plot(tree, tip.color = tip_cols, cex = 0.7)
axisPhylo(side = 1, backward = FALSE)
legend("topright",
       legend = c("Mature B cell", "Not mature B cell"),
       col    = c("blue", "red"),
       pch    = 19,
       pt.cex = 1,
       bty    = "n")
```

Look at weird trifurcation.

```{r}


# check nodes and edges
tree_collapsed=tree
tree_collapsed$edge.length=rep(1,nrow(tree_collapsed$edge))
plot(tree_collapsed)
edgelabels(cex = 0.5)
nodelabels(cex = 0.5)
which(tree$tip.label %in% c("10", "11", "12"))

# mut vafs
weird_cells <-
  c("plate10_wellA11_dna_run50382","plate10_wellF8_dna_run50382","plate10_wellC6_dna_run50382")
muts_vafs <-
  as.matrix(mats$NV / mats$NR) %>%
  tibble::as_tibble(rownames = "mut_id") %>%
  dplyr::select(mut_id, all_of(weird_cells)) %>%
  tidyr::pivot_longer(cols = weird_cells, names_to = "id",
                      values_to = "alt_vaf")

muts_vafs_mat <- as.matrix(mats$NV / mats$NR)
muts_vafs_mat <- muts_vafs_mat[, weird_cells]
heatmap(muts_vafs_mat)

weird_muts <-
  muts_to_branches %>%
  filter(branch %in% c(127, 128, 56, 57, 58)) %>%
  mutate(mut_id = paste(chr, pos, ref, alt, sep = "_")) %>%
  left_join(muts_vafs)

weird_muts %>%
  ggplot(aes(x = mut_id, y = id, fill = alt_vaf)) +
  geom_tile()
```