---
title: "Driver coverage"
author: "Alexandra Tidd"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    fig_width: 8
    keep_md: false
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 4
    theme: lumen
---

```{r setup, include = F, message = F, warning = F, echo = F}
# chunk options
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(warning = FALSE,
                      dpi = 300,
                      message = FALSE)

# libraries
library(magrittr)
library(ggplot2)
```

### Load mutations

```{r load_data}
pta_muts <-
  list.files("out/genotyping/nanoseq_mutations_genotyped_by_chr/",
             pattern = "pta_muts_", full.names = TRUE) %>%
  purrr::map(function(file) {
    file %>%
      readr::read_tsv(show_col_types = FALSE,
                      col_types = readr::cols(chr = readr::col_character())) %>%
      dplyr::transmute(pdid, sample_id, chr = as.character(chr), pos, ref, mut,
                       gene, type, total_depth, ref_depth, mut_depth)
  }) %>%
  dplyr::bind_rows()
nanoseq_muts <-
  readr::read_tsv("out/genotyping/nanoseq_mutations.tsv",
                  col_types = readr::cols(chr = readr::col_character()))
```

### Calculate mutant VAFs

```{r calculate_vafs}
pta_muts <-
  pta_muts %>%
  dplyr::mutate(mut_vaf = mut_depth / total_depth) %>%
  dplyr::select(mut_vaf, everything()) %>%
  dplyr::arrange(-mut_vaf)
pta_muts
```

`r nrow(dplyr::filter(pta_muts, mut_vaf > 0))` / `r nrow(pta_muts)` 
mutations have a VAF > 0 (across cell-x-mutation pairs).

`r dplyr::filter(pta_muts, mut_vaf > 0) %>% dplyr::distinct(chr, pos, ref, mut) %>% nrow()`
/ `r nrow(dplyr::distinct(pta_muts, chr, pos, ref, mut))` 
unique mutations had a VAF > 0 in any cell.

Here we can see the distribution of VAFs for all mutations...

```{r plot_vafs}
pta_muts %>%
  dplyr::pull(mut_vaf) %>%
  hist(breaks = 20, main = "Mutant VAFs", xlab = "VAF")
```

Here we can see the distribution of non-zero VAFs for all mutations...

```{r plot_vafs_no_zeros}
pta_muts %>%
  dplyr::filter(mut_vaf > 0) %>%
  dplyr::pull(mut_vaf) %>%
  hist(breaks = 25, main = "Mutant VAFs", xlab = "VAF")
```

We can look at how these genotyping calls are distributed across the genes...

```{r}
pta_muts %>%
  dplyr::group_by(gene) %>%
  dplyr::mutate(mut_id = paste(chr, pos, ref, mut),
                called = dplyr::case_when(mut_vaf > 0 ~ mut_id, TRUE ~ NA)) %>%
  dplyr::summarise(n_nanoseq_mutations = dplyr::n_distinct(mut_id, na.rm = TRUE),
                   n_called_mutations = dplyr::n_distinct(called, na.rm = TRUE)) %>%
  dplyr::mutate(prop_called = n_called_mutations / n_nanoseq_mutations) %>%
  dplyr::arrange(-n_called_mutations) %>%
  head(15)
```

We can look at how many cells these mutations are spread across...

```{r}
pta_muts %>%
  dplyr::group_by(chr, pos, ref, mut, gene) %>%
  dplyr::mutate(called_sample_id = dplyr::case_when(mut_vaf > 0 ~ sample_id,
                                                    TRUE ~ NA),
                called_vaf = dplyr::case_when(mut_vaf > 0 ~ mut_vaf,
                                              TRUE ~ NA)) %>%
  dplyr::summarise(n_cells = dplyr::n_distinct(sample_id),
                   n_called_cells = dplyr::n_distinct(called_sample_id, na.rm = TRUE),
                   mean_called_vaf = mean(called_vaf, na.rm = TRUE)) %>%
  dplyr::arrange(-n_called_cells) %>%
  head(15)
```