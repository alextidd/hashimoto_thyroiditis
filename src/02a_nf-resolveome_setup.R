#!/usr/bin/env Rscript

# libraries
library(magrittr)

# dirs
wd <- getwd()
out_dir <- file.path(wd, "out/nf-resolveome/muts_and_snps/")
dir.create(out_dir, showWarnings = FALSE)

# get clean cells only (and cells that have not yet been assessed)
clean_cell_ids <-
  system("ls data/manual_inspection/PD*.tsv", intern = TRUE) %>%
  purrr::map(readr::read_tsv) %>%
  dplyr::bind_rows() %>%
  dplyr::filter(!suspected_doublet | is.na(suspected_doublet),
                !chr_dropout | is.na(chr_dropout)) %>%
  dplyr::pull(cell_id)

# samplesheet
ss_bams <-
  readr::read_csv("data/resolveome/samplesheet_local.csv") %>%
  dplyr::filter(seq_type %in% c("dna", "dnahyb"), cell_id %in% clean_cell_ids)

# function: define mutation type based on ref and alt, split up mnvs and dnvs
type_mutations <- function(df) {
  typed_df <-
    df %>%
    dplyr::mutate(type = dplyr::case_when(
      nchar(ref) == 1 & nchar(alt) == 1 ~ "snv",
      nchar(ref) == 1 & nchar(alt) > 1 ~ "ins",
      nchar(ref) > 1 & nchar(alt) == 1 ~ "del",
      nchar(ref) == 2 & nchar(alt) == 2 ~ "dnv",
      nchar(ref) > 2 & nchar(alt) > 2 ~ "mnv"
    ))

  # expand dnv/mnv mutations to all positions
  if (any(typed_df$type %in% c("dnv", "mnv"))) {
    typed_df_dnv_mnv <-
      typed_df %>%
      dplyr::filter(type %in% c("dnv", "mnv")) %>%
      dplyr::mutate(mut_id = paste(chr, pos, ref, alt, type)) %>%
      dplyr::group_by(dplyr::across(-c(pos, alt, ref))) %>%
      dplyr::reframe(pos = pos:(pos + nchar(alt) - 1),
                     ref = strsplit(ref, split = "") %>% unlist(),
                     alt = strsplit(alt, split = "") %>% unlist()) %>%
      dplyr::select(-mut_id)
    typed_df <-
      typed_df %>%
      dplyr::filter(!(type %in% c("dnv", "mnv"))) %>%
      dplyr::bind_rows(typed_df_dnv_mnv)
  }

  # return
  typed_df
}

# get common snp sites
common_snps <-
  gzfile("/lustre/scratch125/casm/team268im/fa8/117/NOVASEQX_MASKS/NEW_MASKS_wNSX_OCT2024/GRCh37_WGNS/SNP_GRCh37.wgns.bed.gz") %>%
  readr::read_tsv(col_names = c("#CHROM", "START", "POS")) %>%
  dplyr::select(`#CHROM`, POS)

# get a caveman snp file from a sample with high coverage
# extract common snps that are heterozygous
# 0.3 < VAF < 0.7 and DP > 50
# PD63118b_lo0044 has the highest coverage at 68X according to picard
caveman_snps <-
  "/nfs/cancer_ref01/nst_links/live/3464/PD63118b_lo0044/PD63118b_lo0044.caveman_c.snps.vcf.gz" %>%
  readr::read_tsv(comment = "##") %>%
  dplyr::mutate(
    DP = strsplit(INFO, ";") %>% purrr::map_chr(~ .x[grepl("^DP=", .x)]) %>%
      strsplit("=") %>% purrr::map_chr(~ .x[2]) %>% as.integer(),
    VAF = gsub(".*:", "", TUMOUR) %>% as.numeric()) %>%
  dplyr::filter(DP > 50, 0.3 < VAF, VAF < 0.7) %>%
  # get those at common snp sites
  dplyr::inner_join(common_snps) %>%
  dplyr::transmute(donor_id = "PD63118", chr = `#CHROM`, pos = POS, ref = REF,
                   alt = ALT) %>%
  # type the mutations
  type_mutations() %>%
  dplyr::distinct() %>%
  split(.$donor_id)

# get genes to genotype (those approaching gene-level significance in PD63118)
genes_of_interest <-
  readr::read_csv("data/nanoseq/PD63118/mutations2genotype_20250219.csv") %>%
  # get unique mutations
  dplyr::distinct() %>%
  # annotate with dndscv
  dplyr::transmute(sampleID = "PD63118", chr, pos, ref, mut = alt) %>%
  dndscv::dndscv(max_muts_per_gene_per_sample = Inf,
                 max_coding_muts_per_sample = Inf, outp = 1) %>%
  {.$annotmuts$gene} %>%
  unique()

# get mutations
nanoseq_muts <-
  readr::read_tsv("data/nanoseq/hashimoto_exome_targeted_combined_muts.tsv") %>%
  dplyr::filter(gene %in% genes_of_interest) %>%
  dplyr::transmute(chr, pos, ref, alt = mut, donor_id = substr(sampleID, 1, 7)) %>%
  dplyr::distinct() %>%
  split(.$donor_id)

# write mutations and snps
purrr::walk2(names(nanoseq_muts), nanoseq_muts, function(donor_id_i, muts_i) {
  dir.create(file.path(out_dir, donor_id_i))
  muts_i %>%
    readr::write_tsv(
      file.path(out_dir, donor_id_i, "nanoseq_mutations.tsv"))
})
purrr::walk2(names(caveman_snps), caveman_snps, function(donor_id_i, snps_i) {
  snps_i %>%
    readr::write_tsv(
      file.path(out_dir, donor_id_i, "caveman_snps.tsv"))
})

# write samplesheets
ss <-
  ss_bams %>%
  dplyr::mutate(
    mutations = file.path(out_dir, donor_id, "nanoseq_mutations.tsv"),
    mutations = ifelse(file.exists(mutations), mutations, NA),
    snps = file.path(out_dir, donor_id, "caveman_snps.tsv"),
    snps = ifelse(file.exists(snps), snps, NA)) %>%
  {split(., .$seq_type)}
purrr::walk2(names(ss), ss, function(seq_type_i, ss_i) {
  ss_i %>%
    readr::write_csv(file.path("out/nf-resolveome", seq_type_i, "samplesheet.csv"))
})
